# 六神ノ間 サブスクリプション管理ガイド

## 目次
1. [管理者向け：月次運用フロー](#管理者向け月次運用フロー)
2. [ユーザー向け：サブスクリプション継続手順](#ユーザー向けサブスクリプション継続手順)
3. [自動処理システムの説明](#自動処理システムの説明)
4. [トラブルシューティング](#トラブルシューティング)

---

## 管理者向け：月次運用フロー

### 毎月1日：月次合言葉の自動生成

毎月1日に、システムが自動的に新しい月次合言葉を生成します。

**自動処理内容：**
- 新しい月次合言葉（例：`SIX2602ABCD`）が生成される
- 管理者に通知が送信される
- 合言葉は翌月末まで有効

**手動で生成する場合：**
1. 管理画面にログイン
2. 「サブスクリプション管理」→「月次合言葉」
3. 「新規生成」ボタンをクリック

---

### 毎日：振込確認と合言葉送信

#### 手順1：振込確認

1. 楽天銀行にログイン
2. 入金履歴を確認
3. 振込名義と金額を照合

**振込先口座情報：**
```
銀行名: 楽天銀行
支店名: エンカ支店
口座種別: 普通
口座番号: 1479015
口座名義: タケベケイサク
```

**料金プラン：**
| プラン | 金額 | 有効期間 |
|--------|------|----------|
| 月額プラン | ¥1,980 | 30日間 |
| 年間プラン | ¥19,800 | 365日間 |

#### 手順2：合言葉の発行と送信

**方法A：直接有効化（推奨）**
1. 管理画面「振込申請管理」を開く
2. 該当ユーザーの申請を選択
3. 「振込確認・直接有効化」ボタンをクリック
4. ユーザーのプレミアムプランが即座に有効化される
5. ユーザーに自動通知が送信される

**方法B：合言葉発行**
1. 管理画面「振込申請管理」を開く
2. 該当ユーザーの申請を選択
3. 「振込確認・合言葉発行」ボタンをクリック
4. 合言葉が自動生成され、ユーザーに通知される
5. ユーザーが合言葉を入力して有効化

---

### 毎日：自動リマインド通知

システムが自動的に以下の処理を実行します：

1. **3日前リマインド**
   - プレミアム有効期限の3日前にユーザーへ通知
   - 継続の振込案内を自動送信

2. **期限切れ処理**
   - 有効期限が切れたユーザーを自動でダウングレード
   - ユーザーに期限切れ通知を送信

**手動実行する場合：**
```
管理画面 → サブスクリプション管理 → 「日次タスク実行」
```

---

### 月末：継続ユーザーへの対応

#### 継続ユーザーへの合言葉更新フロー

1. **ユーザーからの振込確認**
   - 継続ユーザーは3日前リマインドを受け取る
   - 振込後、管理者が確認

2. **新しい合言葉の発行**
   - 管理画面から「振込確認・合言葉発行」
   - または「直接有効化」で即座に更新

3. **有効期間の延長**
   - 新しい30日間（または365日間）が追加される

---

## ユーザー向け：サブスクリプション継続手順

### プレミアムプランの継続方法

#### ステップ1：振込のご案内を確認

有効期限の3日前に、以下の通知が届きます：

```
⏰ プレミアムプランの継続確認

いつも六神ノ間をご利用いただきありがとうございます。
ご利用中のプランの有効期限が近づいております。

【有効期限】
2026年2月28日

継続をご希望の場合は、以下の口座にお振込みください。
```

#### ステップ2：銀行振込

以下の口座に継続料金をお振込みください：

```
【振込先口座】
銀行名: 楽天銀行
支店名: エンカ支店
口座種別: 普通
口座番号: 1479015
口座名義: タケベケイサク

【継続料金】
月額プラン: ¥1,980
年間プラン: ¥19,800
```

**注意事項：**
- 振込名義は登録時のお名前と同一にしてください
- 振込手数料はお客様のご負担となります

#### ステップ3：合言葉の受け取り

振込確認後、1〜2営業日以内に合言葉が届きます：

```
🎉 合言葉が届きました！

お振込みの確認が取れました。ありがとうございます！

【合言葉（アクティベーションコード）】
SIX2602ABCD

上記の合言葉を「プレミアムプラン」ページで入力すると、
30日間のプレミアムプランが有効になります。
```

#### ステップ4：合言葉の入力（必要な場合）

1. 「プレミアムプラン」ページにアクセス
2. 「合言葉を入力」ボタンをクリック
3. 届いた合言葉を入力
4. 「有効化」ボタンをクリック

**直接有効化の場合：**
管理者が直接有効化した場合は、合言葉の入力は不要です。
自動的にプレミアムプランが更新されます。

---

## 自動処理システムの説明

### 日次自動処理（毎日実行）

| 処理内容 | 説明 |
|----------|------|
| 更新リマインド送信 | 有効期限3日前のユーザーに通知 |
| 期限切れ処理 | 期限切れユーザーをダウングレード |
| 紹介報酬処理 | 30日経過した紹介報酬を自動承認 |
| 継続ボーナス付与 | 3/6/12ヶ月継続ユーザーにボーナス |

### 月次自動処理（毎月1日実行）

| 処理内容 | 説明 |
|----------|------|
| 月次合言葉生成 | 新しい月の合言葉を自動生成 |
| 月次レポート | 管理者に月次サマリーを通知 |

### 通知の種類

| 通知タイプ | 送信タイミング | 内容 |
|------------|----------------|------|
| 振込申請受付 | 申請時 | 振込先口座情報 |
| 合言葉発行 | 振込確認後 | 合言葉と有効化手順 |
| 更新リマインド | 有効期限3日前 | 継続案内と振込先 |
| 期限切れ通知 | 期限切れ時 | ダウングレード通知 |

---

## トラブルシューティング

### よくある問題と解決方法

#### Q: 合言葉が届かない
**A:** 以下を確認してください：
1. 通知設定がオンになっているか
2. 振込名義が登録名と一致しているか
3. 管理者に直接お問い合わせください

#### Q: 合言葉が無効と表示される
**A:** 以下の原因が考えられます：
1. 合言葉の有効期限（7日間）が切れている
2. 入力ミス（大文字・小文字を確認）
3. すでに使用済みの合言葉

#### Q: 振込したのにプランが更新されない
**A:** 振込確認には1〜2営業日かかります。
土日祝日は翌営業日の対応となります。

#### Q: 自動リマインドが届かない
**A:** 管理者向け：
1. 管理画面で「日次タスク実行」を手動実行
2. ユーザーの`renewalReminderSent`フラグを確認
3. 通知設定を確認

---

## 管理者向けAPIエンドポイント

### サブスクリプション管理

```typescript
// 日次タスク実行
trpc.rewards.runSubscriptionTasks.useMutation()

// 月次合言葉生成
trpc.rewards.generateMonthlyCode.useMutation()

// 現在の月次合言葉取得
trpc.rewards.getCurrentMonthlyCode.useQuery()

// 月次合言葉履歴取得
trpc.rewards.getMonthlyCodeHistory.useQuery()

// サブスクリプション統計取得
trpc.rewards.getSubscriptionStats.useQuery()

// 更新リマインド手動送信
trpc.rewards.sendRenewalReminders.useMutation()

// 期限切れ処理手動実行
trpc.rewards.processExpiredSubscriptions.useMutation()

// 全日次タスク実行（紹介報酬 + サブスクリプション）
trpc.rewards.runAllDailyTasks.useMutation()
```

---

## 連絡先

**サポート窓口**
- お問い合わせフォーム: サイト内「お問い合わせ」
- 対応時間: 平日10:00〜18:00

---

*最終更新: 2026年1月30日*
