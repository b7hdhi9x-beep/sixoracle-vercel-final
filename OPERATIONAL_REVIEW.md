# 六神ノ間 (Six Oracle) - 運営レビュー

## 1. 決済フロー

### 現在の実装状況

| 項目 | 状態 | 詳細 |
|------|------|------|
| Stripe Checkout | ✅ 実装済み | ユーザーがアップグレードボタンをクリックするとStripe決済ページへ遷移 |
| Webhook処理 | ✅ 実装済み | `checkout.session.completed`でプレミアムステータスを更新 |
| サブスク更新 | ✅ 実装済み | `customer.subscription.updated`で状態を同期 |
| 解約処理 | ✅ 実装済み | `customer.subscription.deleted`でプレミアムを解除 |
| 支払い失敗 | ✅ 実装済み | `invoice.payment_failed`で`past_due`状態に更新 |

### 決済完了時の動作
1. Stripeで決済完了 → Webhookが発火
2. `checkout.session.completed`イベントを受信
3. ユーザーの`isPremium`を`true`に更新
4. `subscriptionStatus`を`active`に更新
5. ダッシュボードで即座に100回/日の制限に切り替わる

## 2. 利用制限

### 現在の制限設定

| プラン | 1日の鑑定回数 | メッセージ上限 |
|--------|--------------|---------------|
| 無料会員 | 3回 | 2000文字/回 |
| プレミアム | 100回 | 2000文字/回 |

### 制限の実装
- `dailyUsage`テーブルで日別の利用回数を追跡
- 各チャットリクエスト前に制限をチェック
- 制限超過時はエラーメッセージを表示

## 3. コスト管理とリスク

### LLM API（Manus Forge API）

**現状の問題点:**
- LLM呼び出しは`BUILT_IN_FORGE_API_KEY`を使用
- これはManusプラットフォームが提供するAPI
- **Manusクレジットが不足した場合、LLM呼び出しが失敗する可能性あり**

**推奨対策:**
1. エラーハンドリングの強化（API失敗時のユーザーへの通知）
2. Manusクレジットの監視と通知設定
3. 代替APIキーの設定オプション（将来的に）

### ヘビーユーザー対策

**現在の保護:**
- プレミアムでも1日100回の上限あり
- 1メッセージ2000文字制限
- max_tokens: 32768（応答の最大長）

**追加推奨:**
1. 月間の総利用回数制限（例: 3000回/月）
2. 連続リクエストのレート制限（例: 10秒に1回）
3. 異常利用の検知と通知

## 4. 潜在的な問題点

### 要対応

| 問題 | 重要度 | 対策 |
|------|--------|------|
| LLM API失敗時のエラー処理 | 高 | ユーザーフレンドリーなエラーメッセージ表示 |
| Manusクレジット枯渇 | 高 | クレジット監視・通知設定 |
| Webhook署名検証失敗 | 中 | ログ監視・アラート設定 |

### 実装済みの保護

| 保護機能 | 状態 |
|----------|------|
| 日次利用制限 | ✅ |
| メッセージ長制限 | ✅ |
| 認証必須（ログイン） | ✅ |
| Stripe Webhook署名検証 | ✅ |

## 5. 推奨アクション

### 即座に対応すべき項目

1. **Stripeサンドボックスの有効化**
   - https://dashboard.stripe.com/claim_sandbox から有効化
   - 期限: 2026-03-21

2. **Manusクレジットの確認**
   - 現在のクレジット残高を確認
   - 低残高時の通知設定

### 将来的な改善

1. **レート制限の追加**
   - 連続リクエストの制限（スパム防止）

2. **月間制限の追加**
   - プレミアムユーザーの月間総利用回数制限

3. **コスト監視ダッシュボード**
   - LLM API呼び出し回数の可視化
   - 収益とコストの比較

## 6. 結論

現在の実装は基本的な運営に必要な機能を備えています。決済完了時のプレミアム切り替えは正常に動作し、利用制限も適切に設定されています。

ただし、**Manusクレジットの枯渇リスク**については注意が必要です。LLM APIはManusプラットフォームに依存しているため、クレジット管理を適切に行う必要があります。
