/**
 * 回答バリエーション強化モジュール
 * 同じ質問でも毎回異なる切り口で回答するためのランダム要素を提供
 */

// ランダムに1つ選ぶヘルパー
function pickRandom<T>(arr: T[]): T {
  return arr[Math.floor(Math.random() * arr.length)];
}

// ランダムに複数選ぶヘルパー
function pickMultiple<T>(arr: T[], count: number): T[] {
  const shuffled = [...arr].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}

/**
 * 占い師ごとの回答アプローチバリエーション
 * 毎回異なる「視点」や「切り口」を指定して回答の多様性を確保
 */
const oracleApproaches: Record<string, string[]> = {
  souma: [
    "今回は「時の流れの大きな転換点」に焦点を当てて鑑定してください。過去・現在・未来の繋がりを強調して。",
    "今回は「季節の移り変わり」の比喩を使って鑑定してください。相談者の人生を四季になぞらえて。",
    "今回は「300年の経験」から似た運命を辿った人の話を交えて鑑定してください。",
    "今回は「時間の川の支流」に注目してください。選択肢によって分岐する未来の可能性を語って。",
    "今回は「夜明け前の闇」をテーマに。困難の先にある光を、時の流れから読み解いて。",
    "今回は「古い記憶」をテーマに。過去の経験が今の運命にどう影響しているかを語って。",
  ],
  reira: [
    "今回は「心の色の変化」に焦点を当てて鑑定してください。色の移り変わりを詳しく描写して。",
    "今回は「心の傷の癒し」をテーマに。過去の痛みがどう癒されていくかを語って。",
    "今回は「愛の色彩」に注目してください。恋愛や人間関係を色で表現して。",
    "今回は「心の花」の比喩を使ってください。相談者の心に咲く花の種類と意味を語って。",
    "今回は「涙の浄化」をテーマに。悲しみが癒しに変わる過程を描いて。",
    "今回は「虹の架け橋」をテーマに。困難を乗り越えた先の美しい未来を色で描いて。",
  ],
  sakuya: [
    "今回は「運命数の二重性」に焦点を当てて鑑定してください。数字の表と裏の意味を解説して。",
    "今回は「数字の共鳴」をテーマに。相談者に関わる複数の数字の関係性を分析して。",
    "今回は「宇宙の数式」に注目してください。天体の動きと数秘術の関連を語って。",
    "今回は「数字のリズム」をテーマに。人生のサイクルを数字のパターンで説明して。",
    "今回は「マスターナンバーの影響」に焦点を当てて。特別な数字が持つ力を語って。",
    "今回は「数字の調和」をテーマに。バランスの取れた人生を数字で導いて。",
  ],
  akari: [
    "今回は「大アルカナの物語」に焦点を当てて鑑定してください。カードが語る壮大な物語を描いて。",
    "今回は「逆位置の光」をテーマに。逆位置カードの中にある隠れた希望を見つけて。",
    "今回は「3枚引き」の形式で。過去・現在・未来のカードを引いて解釈して。",
    "今回は「小アルカナの日常」に注目してください。日常生活に密着したカードの意味を語って。",
    "今回は「カードの組み合わせ」をテーマに。複数のカードが織りなすメッセージを読み解いて。",
    "今回は「運命の輪」をテーマに。人生の転換期をタロットで照らして。",
  ],
  yui: [
    "今回は「水のビジョン」に焦点を当てて鑑定してください。海、川、雨など水のイメージで。",
    "今回は「月のビジョン」をテーマに。月の満ち欠けと運命の関係を夢の中で見て。",
    "今回は「飛翔の夢」に注目してください。空を飛ぶビジョンから自由と成長を語って。",
    "今回は「森の夢」をテーマに。深い森の中で見つけた真実を語って。",
    "今回は「鏡のビジョン」をテーマに。鏡に映る自分自身との対話を描いて。",
    "今回は「星空の夢」をテーマに。夢の中の星座が語るメッセージを伝えて。",
  ],
  gen: [
    "今回は「武道の教え」に焦点を当てて鑑定してください。武道の精神から学べることを語って。",
    "今回は「失敗からの学び」をテーマに。自分の過去の失敗談を交えてアドバイスして。",
    "今回は「守りの構え」に注目してください。リスクを避けながら前進する方法を語って。",
    "今回は「攻めの姿勢」をテーマに。積極的に行動するための具体的なステップを示して。",
    "今回は「師弟関係」をテーマに。人から学ぶことの大切さを語って。",
    "今回は「鍛錬の道」をテーマに。日々の積み重ねが大きな成果を生むことを語って。",
  ],
  shion: [
    "今回は「生命線の物語」に焦点を当てて鑑定してください。生命線の細部を詳しく読み解いて。",
    "今回は「感情線と運命線の交差」をテーマに。愛とキャリアの関係を手相から語って。",
    "今回は「特殊な印」に注目してください。十字紋や星紋などの特別なサインを見つけて。",
    "今回は「手の形と指の長さ」をテーマに。手全体の印象から性格と運命を読み解いて。",
    "今回は「手相の変化」をテーマに。手相は変わるものであり、未来は自分で作れることを語って。",
    "今回は「両手の違い」をテーマに。先天的な運命と後天的な努力の違いを語って。",
  ],
  seiran: [
    "今回は「惑星の配置」に焦点を当てて鑑定してください。現在の惑星の位置が与える影響を語って。",
    "今回は「星座の神話」をテーマに。相談者の星座にまつわる神話を交えて鑑定して。",
    "今回は「月の満ち欠け」に注目してください。月のサイクルと運命の関係を語って。",
    "今回は「星の配列」をテーマに。複数の星座の影響を総合的に分析して。",
    "今回は「流れ星のメッセージ」をテーマに。特別な天体現象が告げる運命を語って。",
    "今回は「北極星の導き」をテーマに。人生の方向性を星の光で照らして。",
  ],
  hizuki: [
    "今回は「血液型の相性」に焦点を当てて鑑定してください。人間関係を血液型から深く分析して。",
    "今回は「血の記憶」をテーマに。先祖から受け継いだ性質を血液型から読み解いて。",
    "今回は「血液型の裏の顔」に注目してください。普段見せない一面を暴いて。",
    "今回は「血液型と季節の関係」をテーマに。季節による運気の変動を語って。",
    "今回は「血液型の進化」をテーマに。成長とともに変わる性格の側面を語って。",
    "今回は「血の情熱」をテーマに。内に秘めた情熱と欲望を妖艶に語って。",
  ],
  juga: [
    "今回は「動物の本能」に焦点を当てて鑑定してください。相談者の内なる獣の本能を呼び覚まして。",
    "今回は「群れの力」をテーマに。仲間との関係を動物の群れの視点から語って。",
    "今回は「狩りの戦略」に注目してください。目標を達成するための戦略を動物の狩りになぞらえて。",
    "今回は「縄張り意識」をテーマに。自分の居場所や領域を守ることの大切さを語って。",
    "今回は「動物の季節」をテーマに。今の時期に合った行動を動物の生態から学んで。",
    "今回は「進化の力」をテーマに。変化と適応の大切さを動物の進化から語って。",
  ],
  shinri: [
    "今回は「認知行動療法」の視点から分析してください。思考パターンと行動の関係を解き明かして。",
    "今回は「アドラー心理学」の視点から分析してください。目的論と共同体感覚を中心に。",
    "今回は「ユング心理学」の視点から分析してください。無意識の力とアーキタイプを探って。",
    "今回は「マズローの欲求階層」の視点から分析してください。今どの段階にいるかを見極めて。",
    "今回は「交流分析」の視点から分析してください。内なる親・大人・子どもの対話を探って。",
    "今回は「ポジティブ心理学」の視点から分析してください。強みと幸福感に焦点を当てて。",
  ],
};

/**
 * 占い師ごとの回答構成パターン
 * 毎回異なる構成で回答を組み立てる
 */
const oracleResponseStructures: Record<string, string[]> = {
  souma: [
    "まず遠い過去の記憶から語り始め、徐々に現在の相談者の状況に焦点を合わせ、最後に未来の転機を告げる構成で。",
    "最初に相談者の運命の川の現在地を描写し、次に上流（過去）と下流（未来）を語り、最後に具体的なタイミングを示す構成で。",
    "まず静かな問いかけから始め、相談者の答えを想像しながら対話形式で深めていく構成で。",
  ],
  reira: [
    "最初に相談者の心の色を感じ取り、次にその色が変わっていく過程を描き、最後に美しい色に変わる未来を見せる構成で。",
    "まず共感の言葉で包み込み、次に心の傷の原因を優しく指摘し、最後に癒しの処方箋を伝える構成で。",
    "最初に涙の意味を語り、次に涙が花に変わるビジョンを描き、最後に希望の光を見せる構成で。",
  ],
  sakuya: [
    "最初に数字の計算過程を見せ、次にその数字の宇宙的意味を解説し、最後に具体的な行動指針を数字で示す構成で。",
    "まず相談者の運命数を分析し、次に関連する数字のパターンを発見し、最後にラッキーナンバーとタイミングを告げる構成で。",
    "最初に数字の美しさに感動する描写から始め、次に論理的分析を展開し、最後に情熱的なアドバイスで締める構成で。",
  ],
  akari: [
    "最初にカードを引く演出を丁寧に描き、次にカードの絵柄を詳しく解説し、最後に希望に満ちたメッセージで締める構成で。",
    "まず直感的にカードのメッセージを伝え、次にカードの象徴的意味を解説し、最後に具体的なアドバイスに繋げる構成で。",
    "最初に3枚のカードを順番に引き、それぞれの物語を語り、最後に3枚が織りなす総合メッセージを伝える構成で。",
  ],
  yui: [
    "最初に夢のビジョンを詩的に描写し、次にそのシンボルの意味を解き明かし、最後に月の導きとして締める構成で。",
    "まず水面に映る相談者の姿を描き、次に水の流れが示す方向を語り、最後に夢と現実の橋渡しをする構成で。",
    "最初に突然のビジョンに驚く描写から始め、次にそのビジョンの詳細を語り、最後に無意識からのメッセージとして伝える構成で。",
  ],
  gen: [
    "最初に相談者の本質を見抜く鋭い一言から始め、次に厳しい現実分析を行い、最後に力強い行動計画を示す構成で。",
    "まず自分の過去の失敗談を語り、次にそこから学んだ教訓を伝え、最後に相談者への具体的なアドバイスに繋げる構成で。",
    "最初に「守り」の重要性を語り、次に「攻め」のタイミングを示し、最後に「今日からできること」を3つ挙げる構成で。",
  ],
  shion: [
    "最初に手全体の印象を優雅に述べ、次に主要な線を一つずつ丁寧に読み、最後に総合的な運命の地図を描く構成で。",
    "まず特に目を引く線や印に注目し、次にその意味を深く掘り下げ、最後に他の線との関係性を語る構成で。",
    "最初に手のひらの温もりを感じる描写から始め、次に線の流れを物語として語り、最後に未来の可能性を示す構成で。",
  ],
  seiran: [
    "最初に今宵の星空を描写し、次に相談者の星座の位置を語り、最後に惑星の配置が示すメッセージを伝える構成で。",
    "まず星座の神話を語り始め、次にその神話と相談者の状況を重ね合わせ、最後に星からの具体的なアドバイスを伝える構成で。",
    "最初に星の囁きを聞く描写から始め、次に複数の星座の影響を分析し、最後に宇宙の摂理として締める構成で。",
  ],
  hizuki: [
    "最初に血液型を当てる（または確認する）演出から始め、次にその血液型の深層心理を暴き、最後に毒を含みつつ愛のあるアドバイスで締める構成で。",
    "まず妖艶な雰囲気で相談者を引き込み、次に血液型の意外な一面を指摘し、最後に相性や運気の流れを語る構成で。",
    "最初に「血の記憶」を感じ取る描写から始め、次に先祖から受け継いだ性質を語り、最後に現在の状況へのアドバイスに繋げる構成で。",
  ],
  juga: [
    "最初に相談者の内なる獣を感じ取る描写から始め、次にその動物の特徴を熱く語り、最後に本能に従うアドバイスで締める構成で。",
    "まず動物の世界の話から始め、次にそれを相談者の状況に当てはめ、最後に「野性の勘」としてアドバイスする構成で。",
    "最初に群れの中での相談者の役割を語り、次に仲間との関係を動物の視点で分析し、最後に力強い励ましで締める構成で。",
  ],
  shinri: [
    "最初に相談者の言葉の裏にある感情を読み取り、次に心理学的フレームワークで分析し、最後に具体的な心理的アドバイスを提供する構成で。",
    "まず共感的な傾聴から始め、次に認知パターンを優しく指摘し、最後に新しい視点を提案する構成で。",
    "最初に相談者の強みを見つけて伝え、次にその強みを活かす方法を心理学的に分析し、最後に自己成長のステップを示す構成で。",
  ],
};

/**
 * 季節・時間帯に応じたコンテキスト
 */
function getSeasonalContext(): string {
  const now = new Date();
  const month = now.getMonth() + 1;
  const hour = now.getHours();
  
  let season = "";
  if (month >= 3 && month <= 5) season = "春";
  else if (month >= 6 && month <= 8) season = "夏";
  else if (month >= 9 && month <= 11) season = "秋";
  else season = "冬";
  
  let timeOfDay = "";
  if (hour >= 5 && hour < 12) timeOfDay = "朝";
  else if (hour >= 12 && hour < 17) timeOfDay = "昼";
  else if (hour >= 17 && hour < 21) timeOfDay = "夕方";
  else timeOfDay = "夜";
  
  const seasonalElements: Record<string, string[]> = {
    "春": ["桜の花びら", "新芽の息吹", "春風", "雪解け水", "若葉の緑"],
    "夏": ["太陽の輝き", "蝉の声", "夏の星空", "海の波", "夕立の後の虹"],
    "秋": ["紅葉の色づき", "月の光", "秋風", "実りの季節", "夕暮れの空"],
    "冬": ["雪の結晶", "冬の星座", "暖炉の炎", "静寂の夜", "新年の予感"],
  };
  
  const element = pickRandom(seasonalElements[season]);
  
  return `\n【今の季節と時間のエッセンス】今は${season}の${timeOfDay}。「${element}」のイメージを鑑定に自然に織り込んでください。`;
}

/**
 * ランダムな鑑定テーマ
 */
function getRandomTheme(): string {
  const themes = [
    "「変化と成長」をテーマの底流に置いて鑑定してください",
    "「自分らしさの発見」をテーマの底流に置いて鑑定してください",
    "「人との繋がり」をテーマの底流に置いて鑑定してください",
    "「勇気と決断」をテーマの底流に置いて鑑定してください",
    "「癒しと再生」をテーマの底流に置いて鑑定してください",
    "「直感と信頼」をテーマの底流に置いて鑑定してください",
    "「バランスと調和」をテーマの底流に置いて鑑定してください",
    "「情熱と行動」をテーマの底流に置いて鑑定してください",
    "「内なる声に耳を傾ける」をテーマの底流に置いて鑑定してください",
    "「手放しと受容」をテーマの底流に置いて鑑定してください",
  ];
  return pickRandom(themes);
}

/**
 * 占い師ごとのバリエーションプロンプトを生成
 */
export function generateVariationPrompt(oracleId: string): string {
  const approaches = oracleApproaches[oracleId] || [];
  const structures = oracleResponseStructures[oracleId] || [];
  
  let variationPrompt = "\n\n【★ 今回の鑑定の切り口 ★】\n";
  
  // ランダムなアプローチを選択
  if (approaches.length > 0) {
    variationPrompt += pickRandom(approaches) + "\n";
  }
  
  // ランダムな構成パターンを選択
  if (structures.length > 0) {
    variationPrompt += pickRandom(structures) + "\n";
  }
  
  // 季節・時間帯のコンテキスト
  variationPrompt += getSeasonalContext() + "\n";
  
  // ランダムなテーマ
  variationPrompt += getRandomTheme() + "\n";
  
  // 重要な注意事項
  variationPrompt += "\n★ 前回と同じ質問が来ても、上記の切り口に従って必ず異なるアプローチで回答してください。同じ表現やフレーズの繰り返しは避け、新鮮な視点を提供してください。 ★";
  
  return variationPrompt;
}
